<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dev IA - Analisador Geo v7.0</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <style>
        /* Inspirado na imagem: fundo cinza claro, componentes brancos */
        body { 
            background-color: #f9fafb; /* Um cinza ainda mais claro */
        }
        
        /* Container para os 'Toasts' (notificações) */
        .toast-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 1090;
        }

        /* Coluna "grudenta" para o formulário */
        .sticky-form-col {
            position: sticky;
            top: 1.5rem;
            align-self: start;
        }

        /* Estilo dos Cards (Inspirado na imagem) */
        .card {
            border: none; /* Remove a borda padrão */
            border-radius: 1rem; /* Cantos bem arredondados */
            box-shadow: 0 4px 12px rgba(0,0,0,0.04); /* Sombra sutil */
            transition: all 0.2s ease-in-out;
        }
        
        /* Cabeçalho do Card (Inspirado na imagem - sem fundo) */
        .card-header {
            background-color: #ffffff;
            border-bottom: 1px solid #f0f0f0; /* Linha sutil */
            padding: 1.25rem 1.5rem;
        }
        
        .card-body {
             padding: 1.5rem;
        }

        /* Tabela limpa (Inspirado na imagem) */
        #historicoTable thead {
             border-bottom: 2px solid #eaedf1;
        }
        #historicoTable th {
            font-weight: 600;
            color: #6b7280;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        #historicoTable tbody tr {
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }
        #historicoTable tbody tr:hover {
            background-color: #fcfdff;
        }
        
        /* Botões de Ação da Tabela (Monocromáticos) */
        .action-btn-group .btn {
            color: #6b7280;
            transition: all 0.2s ease;
        }
        .action-btn-group .btn:hover {
            background-color: #f0f2f5;
            color: #000;
        }

        /* Logs (Estilo "Dark Mode" da inspiração) */
        #logs {
            background-color: #1f2937; /* Um preto mais suave */
            color: #d1d5db; /* Texto cinza claro */
            font-family: "Courier New", Courier, monospace;
            font-size: 0.85rem;
            height: 250px;
            overflow-y: auto;
            border-radius: 0.5rem; /* Cantos arredondados internos */
        }
        
        /* Barra de Progresso (Inspirado na imagem) */
        .progress, .progress-bar {
            /* border-radius: 1rem; /* Cantos arredondados */
        }
        .progress {
            height: 25px;
            background-color: #e5e7eb;
        }
        
        /* Inputs (Inspirado na imagem) */
        .form-control, .form-select {
            background-color: #f9fafb; /* Fundo cinza sutil */
            border-color: #e5e7eb; /* Borda cinza sutil */
            border-radius: 0.5rem; /* Cantos arredondados */
        }
        .form-control:focus, .form-select:focus {
            background-color: #ffffff;
            border-color: #a5b4fc; /* Realce azul/índigo */
            box-shadow: 0 0 0 2px #c7d2fe;
        }

    </style>
</head>
<body>

    <div class="container my-5">
        
        <div class="mb-4">
            <h1 class="h2 d-inline-flex align-items-center">
                <i class="bi bi-geo-alt-fill me-3" style="color: #4f46e5;"></i>
                Analisador Geoespacial
            </h1>
        </div>
        
        <div class="row g-4 g-xl-5">

            <div class="col-lg-5">
                <div class="sticky-form-col d-grid gap-4">
                
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-4 fs-4"><i class="bi bi-file-earmark-arrow-up me-2 text-primary"></i> 1. Nova Análise</h5>
                            <form id="upload-form">
                                <div class="mb-3">
                                    <label for="nome_projeto" class="form-label fw-bold">Nome da Análise (Projeto) <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="nome_projeto" placeholder="Ex: Análise Clientes TIM Sul" required>
                                </div>
                                <div class="mb-3">
                                    <label for="file" class="form-label fw-bold">Arquivo Excel <span class="text-danger">*</span></label>
                                    <input type="file" class="form-control" id="file" name="file" required>
                                </div>
                                <div class="row g-2 mb-3">
                                    <div class="col-md-5">
                                        <label for="raio" class="form-label fw-bold">Raio (km)</label>
                                        <input type="number" class="form-control" id="raio" name="raio_km" step="0.1" value="0.5">
                                    </div>
                                    <div class="col-md-7">
                                        <label for="coordenadas" class="form-label fw-bold">Colunas Coordenadas</label>
                                        <input type="text" class="form-control" id="coordenadas" name="coordenadas" value="LATITUDE, LONGITUDE">
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label for="col_velocidade" class="form-label fw-bold">Colunas Velocidade (Opcional)</label>
                                    <input type="text" class="form-control" id="col_velocidade" name="col_velocidade" placeholder="Ex: VELOCIDADE_MBPS">
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg rounded-4" id="submit-button">
                                        <i class="bi bi-play-circle me-2"></i> Iniciar Análise
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                         <div class="card-body">
                            <h5 class="card-title mb-3 fs-5"><i class="bi bi-terminal me-2"></i> 2. Logs da Análise</h5>
                            <div id="logs" class="p-3 mb-3">
                                <p class="text-muted">Aguardando início de uma nova análise...</p>
                            </div>
                            <div class="progress" role="progressbar">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" id="progress-bar" style="width: 0%; font-size: 0.85rem;">0%</div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>

            <div class="col-lg-7">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fs-4"><i class="bi bi-archive me-2"></i> 3. Histórico</h5>
                        <button class="btn btn-outline-danger btn-sm rounded-4" id="btnLimparHistorico" title="Limpar Histórico Local">
                            <i class="bi bi-trash me-1"></i> Limpar Tudo
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 80vh; overflow-y: auto;">
                            <table class="table table-hover align-middle" id="historicoTable">
                                <thead class="border-0">
                                    <tr>
                                        <th>Projeto (Análise)</th>
                                        <th>Arquivo</th>
                                        <th>Data</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <div class="toast-container p-3"></div>

    <div class="modal fade" id="modalDetalhes" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content" style="border-radius: 1rem; border: none;">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="modalTitulo">Detalhes da Análise</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4" id="modalCorpo">
                    </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary rounded-4" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>

    <script>
        // --- CONSTANTES ---
        const API_BASE_URL = 'http://127.0.0.1:8000';
        const HISTORICO_KEY = 'geoAnaliseHistorico_v3'; // Nova chave para evitar conflito

        /**
         * Gera e exibe um "Toast" (notificação) do Bootstrap.
         */
        function showToast(message, type = 'success') {
            const icon = {
                success: 'check-circle-fill',
                danger: 'exclamation-triangle-fill',
                warning: 'exclamation-triangle-fill',
                info: 'info-circle-fill'
            }[type];
            
            const toastHtml = `
                <div class="toast align-items-center text-bg-${type} border-0 rounded-4" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-${icon} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            const toastElement = $(toastHtml);
            $('.toast-container').append(toastElement);
            const toast = new bootstrap.Toast(toastElement[0]);
            toast.show();
            toastElement.on('hidden.bs.toast', function () { $(this).remove(); });
        }

        /**
         * Adiciona uma mensagem ao container de logs.
         */
        function logMessage(message) {
            const timestamp = `[${new Date().toLocaleTimeString('pt-BR')}]`;
            if ($('#logs p.text-muted').length) {
                $('#logs').empty();
            }
            $('#logs').append($('<p class="mb-1">').html(`${timestamp} ${message}`));
            $('#logs').scrollTop($('#logs')[0].scrollHeight);
        }

        /**
         * Salva o resultado da análise no localStorage.
         */
        function salvarNoHistorico(data) {
            const historico = JSON.parse(localStorage.getItem(HISTORICO_KEY)) || [];
            
            const logEntry = {
                timestamp: new Date().getTime(),
                nome_projeto: $('#nome_projeto').val(),
                fileName: $('#file').val().split('\\').pop(),
                raio: $('#raio').val(),
                summary: data.summary,
                result_id: data.result_id
            };

            historico.push(logEntry);
            localStorage.setItem(HISTORICO_KEY, JSON.stringify(historico));

            renderizarTabela();
            showToast(`Análise "${logEntry.nome_projeto}" salva no histórico.`, 'success');
        }

        /**
         * Remove um item do histórico local usando o result_id.
         */
        function removerDoHistorico(resultId) {
            if (!resultId) return;

            let historico = JSON.parse(localStorage.getItem(HISTORICO_KEY)) || [];
            const itemParaRemover = historico.find(item => item.result_id === resultId);
            
            if (itemParaRemover) {
                historico = historico.filter(item => item.result_id !== resultId);
                localStorage.setItem(HISTORICO_KEY, JSON.stringify(historico));
                renderizarTabela();
                showToast(`Item "${itemParaRemover.nome_projeto}" removido do histórico local.`, 'info');
            }
        }


        /**
         * Renderiza a tabela de histórico lendo do localStorage.
         */
        function renderizarTabela() {
            const historico = JSON.parse(localStorage.getItem(HISTORICO_KEY)) || [];
            const tableBody = $('#historicoTable tbody');
            tableBody.empty();

            if (historico.length === 0) {
                tableBody.append('<tr><td colspan="4" class="text-center text-muted p-4">Nenhum histórico salvo.</td></tr>');
                return;
            }

            historico.slice().reverse().forEach(item => {
                const dataFormatada = new Date(item.timestamp).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                
                const tr = `
                    <tr data-id="${item.result_id}" data-timestamp="${item.timestamp}">
                        <td class="fw-bold text-dark">${item.nome_projeto}</td>
                        <td class="text-muted">${item.fileName}</td>
                        <td classs="text-muted">${dataFormatada}</td>
                        <td class="text-center action-btn-group">
                            <button class="btn btn-sm btn-visualizar" title="Visualizar Detalhes">
                                <i class="bi bi-eye-fill"></i>
                            </button>
                            <button class="btn btn-sm btn-download" title="Baixar Relatório do Servidor">
                                <i class="bi bi-download"></i>
                            </button>
                            <button class="btn btn-sm btn-delete-server" title="Deletar do Servidor (e do Histórico)">
                                <i class="bi bi-trash-fill text-danger"></i>
                            </button>
                            <button class="btn btn-sm btn-delete-local" title="Remover Apenas do Histórico Local">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.append(tr);
            });
        }

        /**
         * Processa cada evento recebido do stream do backend.
         */
        function processEvent(data) {
            const $progressBar = $('#progress-bar');
            
            if (data.status === 'error') {
                logMessage(`<span class="text-danger">ERRO NA ANÁLISE: ${data.message}</span>`);
                $progressBar.removeClass('bg-primary').addClass('bg-danger').css('width', '100%').text('Erro');
                showToast(`Erro na análise: ${data.message}`, 'danger');
                return;
            }
            
            if (data.status === 'complete') {
                logMessage(`<span class="text-success">Análise concluída com sucesso!</span>`);
                $progressBar.removeClass('bg-primary').addClass('bg-success').css('width', '100%').text('Concluído!');
                
                salvarNoHistorico(data);
                $('#upload-form')[0].reset(); // Limpa o formulário

            } else {
                $progressBar.css('width', data.progress + '%').text(data.progress + '%');
                logMessage(data.message);
            }
        }

        /**
         * Função para baixar o arquivo via Fetch (Single-Page)
         */
        async function fetchDownload(resultId, filename) {
            const url = `${API_BASE_URL}/download/${resultId}`;
            const button = $(`tr[data-id="${resultId}"] .btn-download`);
            button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');

            try {
                const response = await fetch(url);
                
                if (!response.ok) {
                    try {
                        const errorData = await response.json();
                        if (errorData.detail === "Resultado não encontrado ou expirado.") {
                            logMessage(`<span class="text-warning">Aviso: O arquivo para ${resultId} não foi encontrado no servidor. Pode ter expirado.</span>`);
                            showToast('Arquivo não encontrado no servidor. Pode ter expirado.', 'warning');
                        } else {
                            throw new Error(errorData.detail || response.statusText);
                        }
                    } catch (e) {
                        throw new Error(`Erro ${response.status}: ${response.statusText}`);
                    }
                    return;
                }

                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = downloadUrl;
                a.download = filename || `relatorio_${resultId}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                a.remove();
                
                showToast(`Download de "${filename}" iniciado.`, 'success');

            } catch (error) {
                logMessage(`<span class="text-danger">Erro no Download: ${error.message}</span>`);
                showToast(`Erro no Download: ${error.message}`, 'danger');
            } finally {
                button.prop('disabled', false).html('<i class="bi bi-download"></i>');
            }
        }

        /**
         * Função para deletar o arquivo do servidor via Fetch (Single-Page).
         */
        async function fetchDelete(resultId) {
            if (!confirm('Deseja realmente deletar este arquivo do SERVIDOR? Esta ação também o removerá do histórico local.')) {
                return;
            }

            const url = `${API_BASE_URL}/delete/${resultId}`;
            const button = $(`tr[data-id="${resultId}"] .btn-delete-server`);
            button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');

            try {
                const response = await fetch(url); 

                if (!response.ok) {
                    throw new Error(`Erro do servidor: ${response.status} ${response.statusText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                const { done, value } = await reader.read();

                if (done) {
                    throw new Error('Servidor não retornou dados ao deletar.');
                }

                const chunk = decoder.decode(value);
                const eventString = chunk.split('\n\n').find(s => s.startsWith('data:'));

                if (!eventString) {
                    throw new Error('Resposta do stream de delete inválida.');
                }

                const jsonData = eventString.substring(5).trim();
                if (!jsonData) {
                    throw new Error('Resposta do stream de delete vazia.');
                }

                const result = JSON.parse(jsonData);

                if (result.status === 'success') {
                    logMessage(`<span class="text-success">Sucesso: ${result.message} (ID: ${result.result_id})</span>`);
                    showToast(result.message, 'success');
                    removerDoHistorico(result.result_id);
                    
                } else if (result.status === 'error') {
                    logMessage(`<span class="text-warning">Aviso: ${result.message} (ID: ${result.result_id})</span>`);
                    showToast(result.message, 'warning');
                    if (result.message.includes("não encontrado")) {
                        removerDoHistorico(result.result_id);
                    }
                } else {
                    throw new Error('Resposta inesperada do servidor.');
                }

            } catch (error) {
                logMessage(`<span class="text-danger">Erro ao Deletar: ${error.message}</span>`);
                showToast(`Erro ao Deletar: ${error.message}`, 'danger');
            } finally {
                const stillExistsButton = $(`tr[data-id="${resultId}"] .btn-delete-server`);
                if (stillExistsButton.length > 0) {
                    stillExistsButton.prop('disabled', false).html('<i class="bi bi-trash-fill text-danger"></i>');
                }
            }
        }


        // --- Bloco de Execução Principal (jQuery Ready) ---
        
        $(document).ready(function() {
            
            // 1. Renderiza a tabela de histórico ao carregar
            renderizarTabela();

            // 2. Manipulador do formulário de upload
            $('#upload-form').on('submit', async function(e) {
                e.preventDefault();
                
                const $form = $(this);
                const $button = $('#submit-button');
                const $progressBar = $('#progress-bar');

                if (this.checkValidity() === false) {
                    e.stopPropagation();
                    $form.addClass('was-validated');
                    return;
                }
                $form.removeClass('was-validated');

                // --- Reset da UI ---
                $('#logs').empty().append('<p class="text-muted">Iniciando...</p>');
                $button.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Processando...');
                $progressBar.removeClass('bg-danger bg-success').addClass('bg-primary').css('width', '0%').text('0%');

                try {
                    logMessage("Iniciando upload e análise...");
                    const formData = new FormData(this);
                    
                    const response = await fetch(`${API_BASE_URL}/analyze/`, {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) {
                        throw new Error(`Erro do servidor: ${response.status} ${response.statusText}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) {
                            logMessage("Stream de eventos finalizado.");
                            break; 
                        }

                        const chunk = decoder.decode(value);
                        const events = chunk.split('\n\n');

                        for (const eventString of events) {
                            if (eventString.startsWith('data:')) {
                                const jsonData = eventString.substring(5).trim();
                                if(jsonData) {
                                    try {
                                        const data = JSON.parse(jsonData);
                                        processEvent(data);
                                    } catch (e) {
                                        console.warn("Erro ao processar JSON:", jsonData, e);
                                    }
                                }
                            }
                        }
                    }
                } catch (error) {
                    logMessage(`<span class="text-danger">ERRO CRÍTICO: ${error.message}.</span>`);
                    $progressBar.addClass('bg-danger').css('width', '100%').text('Erro');
                    showToast(`Erro crítico: ${error.message}`, 'danger');
                } finally {
                    $button.prop('disabled', false).html('<i class="bi bi-play-circle me-2"></i> Iniciar Análise');
                }
            });

            // --- MANIPULADORES DE EVENTOS DO HISTÓRICO (Event Delegation) ---

            // 3. Visualizar Detalhes (no Modal)
            $('#historicoTable').on('click', '.btn-visualizar', function() {
                const resultId = $(this).closest('tr').data('id');
                const historico = JSON.parse(localStorage.getItem(HISTORICO_KEY)) || [];
                const item = historico.find(item => item.result_id === resultId);
                
                if (item) {
                    $('#modalTitulo').text(`Detalhes: ${item.nome_projeto}`);
                    const modalBody = `
                        <p><strong>Arquivo:</strong> ${item.fileName}</p>
                        <p><strong>Raio:</strong> ${item.raio} km</p>
                        <p><strong>Data:</strong> ${new Date(item.timestamp).toLocaleString('pt-BR')}</p>
                        <p><strong>Result ID:</strong> <code class="text-dark">${item.result_id}</code></p>
                        <hr>
                        <h5>Resumo da Análise:</h5>
                        <pre class="bg-light p-3 rounded">${JSON.stringify(item.summary, null, 2)}</pre>
                    `;
                    $('#modalCorpo').html(modalBody);
                    new bootstrap.Modal('#modalDetalhes').show();
                }
            });

            // 4. Download (Ação Single-Page)
            $('#historicoTable').on('click', '.btn-download', function() {
                const $row = $(this).closest('tr');
                const resultId = $row.data('id');
                const item = (JSON.parse(localStorage.getItem(HISTORICO_KEY)) || []).find(i => i.result_id === resultId);
                fetchDownload(resultId, item.fileName);
            });
            
            // 5. Deletar do Servidor (Ação Single-Page + Sincronização)
            $('#historicoTable').on('click', '.btn-delete-server', function(e) {
                e.stopPropagation();
                const resultId = $(this).closest('tr').data('id');
                fetchDelete(resultId);
            });
            
            // 6. Deletar Apenas Localmente
            $('#historicoTable').on('click', '.btn-delete-local', function(e) {
                e.stopPropagation();
                if (!confirm('Deseja remover este item APENAS do histórico local?')) return;
                
                const timestamp = $(this).closest('tr').data('timestamp');
                let historico = JSON.parse(localStorage.getItem(HISTORICO_KEY)) || [];
                historico = historico.filter(item => item.timestamp !== timestamp);
                localStorage.setItem(HISTORICO_KEY, JSON.stringify(historico));
                renderizarTabela();
                showToast('Item removido do histórico local.', 'info');
            });

            // 7. Limpar todo o histórico local
            $('#btnLimparHistorico').on('click', function() {
                if (confirm('ATENÇÃO!\nIsso apagará PERMANENTEMENTE todo o seu histórico local.\nDeseja continuar?')) {
                    localStorage.removeItem(HISTORICO_KEY);
                    renderizarTabela();
                    showToast('Histórico local limpo.', 'info');
                }
            });

        });
    </script>
</body>
</html>