<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Teste da API de Análise Geo</title>
    <style>
        body { font-family: sans-serif; padding: 2em; }
        #progress-bar { width: 100%; background-color: #ddd; }
        #progress { width: 0%; height: 30px; background-color: #0d6efd; text-align: center; line-height: 30px; color: white; }
        #logs { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-top: 1em; }
        #summary { margin-top: 1em; padding: 1em; background-color: #f0f0f0; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>Analisador de Viabilidade Geoespacial</h1>
    <form id="upload-form">
        <label for="file">Arquivo Excel:</label>
        <input type="file" id="file" name="file" required><br><br>
        <label for="raio">Raio de Proximidade (km):</label>
        <input type="number" id="raio" name="raio_km" step="0.1" value="0.5"><br><br>
        <label for="coordenadas">Colunas de coordenadas (Ex.: latitude, longitude ou coordenadas):</label>
        <input type="text" id="coordenadas" name="coordenadas" value="LATITUDE, LONGITUDE"><br><br>
        <label for="col_velocidade">Colunas de velocidade (em Mbps):</label>
        <input type="text" id="col_velocidade" name="col_velocidade" value=""><br><br>

        <button type="submit">Iniciar Análise</button>
    </form>

    <h2>Progresso da Análise</h2>
    <div id="progress-bar"><div id="progress">0%</div></div>
    <div id="logs"><p>Aguardando início da análise...</p></div>
    <div id="summary" style="display:none;">
        <h3>Resumo da Análise</h3>
        <pre id="summary-content"></pre>
        <a id="download-link" href="#" target="_blank">Baixar Relatório</a>
        <a id="delete-link" href="#" target="_blank">Deletar Relatório</a>
    </div>

    <script>
        const form = document.getElementById('upload-form');
        const progressBar = document.getElementById('progress');
        const logsContainer = document.getElementById('logs');
        const summaryContainer = document.getElementById('summary');
        const downloadLink = document.getElementById('download-link');
        const deleteLink = document.getElementById('delete-link');
        const summaryContent = document.getElementById('summary-content');
        const submitButton = form.querySelector('button');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // --- Reset da UI ---
            logsContainer.innerHTML = '';
            summaryContainer.style.display = 'none';
            downloadLink.href = '#';
            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';
            progressBar.style.backgroundColor = '#0d6efd'; // Reset color
            logMessage("Iniciando upload e análise...");

            const formData = new FormData(form);

            try {
                // --- A SOLUÇÃO ESTÁ AQUI ---
                // 1. Usamos fetch para enviar como POST, com o FormData no corpo
                const response = await fetch('http://127.0.0.1:8000/analyze/', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error(`Erro do servidor: ${response.status} ${response.statusText}`);
                }

                // 2. Pegamos o "leitor" do corpo da resposta, que é o nosso stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                // 3. Loop para ler o stream continuamente
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        logMessage("Stream de eventos finalizado.");
                        break; 
                    }

                    // Processa os dados recebidos
                    const chunk = decoder.decode(value);
                    const events = chunk.split('\n\n');

                    for (const eventString of events) {
                        if (eventString.startsWith('data:')) {
                            const jsonData = eventString.substring(5).trim();
                            if(jsonData) {
                                try {
                                    const data = JSON.parse(jsonData);
                                    processEvent(data);
                                } catch (e) {
                                    console.error("Erro ao processar JSON do evento:", jsonData);
                                }
                            }
                        }
                    }
                }

            } catch (error) {
                logMessage(`ERRO CRÍTICO: ${error.message}. A análise foi interrompida.`);
                progressBar.style.backgroundColor = '#dc3545'; // Vermelho para erro
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Iniciar Análise';
            }
        });

        function processEvent(data) {
            if (data.status === 'error') {
                logMessage(`ERRO NA ANÁLISE: ${data.message}`);
                progressBar.style.backgroundColor = '#dc3545';
                return;
            }
            
            if (data.status === 'complete') {
                logMessage("Análise concluída com sucesso!");
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';

                summaryContent.textContent = JSON.stringify(data.summary, null, 2);
                downloadLink.href = `http://127.0.0.1:8000/download/${data.result_id}`;
                deleteLink.href = `http://127.0.0.1:8000/delete/${data.result_id}`;
                summaryContainer.style.display = 'block';

            } else {
                progressBar.style.width = data.progress + '%';
                progressBar.textContent = data.progress + '%';
                logMessage(data.message);
            }
        }

        function logMessage(message) {
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString('pt-BR')}] ${message}`;
            logsContainer.appendChild(p);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }
    </script>
</body>
</html>